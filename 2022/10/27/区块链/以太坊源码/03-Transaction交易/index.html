<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://kongpengyq.com').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.1',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"manual","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="Transaction: 一个交易的生老病死概述我们知道，Ethereum的基本模型是基于交易的状态机模型(Transaction-based State Machine)，Transaction是Ethereum执行数据操作的媒介，它主要起到下面的几个作用:  在Layer-1网络上的Account之间进行Native Token的转账。 创建新的Contract。 调用Contract中会修改">
<meta property="og:type" content="article">
<meta property="og:title" content="03-Transaction交易">
<meta property="og:url" content="https://kongpengyq.com/2022/10/27/%E5%8C%BA%E5%9D%97%E9%93%BE/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81/03-Transaction%E4%BA%A4%E6%98%93/index.html">
<meta property="og:site_name" content="YQ &amp; 博客">
<meta property="og:description" content="Transaction: 一个交易的生老病死概述我们知道，Ethereum的基本模型是基于交易的状态机模型(Transaction-based State Machine)，Transaction是Ethereum执行数据操作的媒介，它主要起到下面的几个作用:  在Layer-1网络上的Account之间进行Native Token的转账。 创建新的Contract。 调用Contract中会修改">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kongpengyq.com/noteimg/%E5%8C%BA%E5%9D%97%E9%93%BE/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81/img/tx_exec_calls.png">
<meta property="article:published_time" content="2022-10-26T16:00:00.000Z">
<meta property="article:modified_time" content="2023-11-09T02:01:34.859Z">
<meta property="article:author" content="幺柒YQ">
<meta property="article:tag" content="区块链">
<meta property="article:tag" content="以太坊源码">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kongpengyq.com/noteimg/%E5%8C%BA%E5%9D%97%E9%93%BE/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81/img/tx_exec_calls.png">

<link rel="canonical" href="https://kongpengyq.com/2022/10/27/%E5%8C%BA%E5%9D%97%E9%93%BE/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81/03-Transaction%E4%BA%A4%E6%98%93/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>03-Transaction交易 | YQ & 博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="YQ & 博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YQ & 博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://kongpengyq.com/2022/10/27/%E5%8C%BA%E5%9D%97%E9%93%BE/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81/03-Transaction%E4%BA%A4%E6%98%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avater.png">
      <meta itemprop="name" content="幺柒YQ">
      <meta itemprop="description" content="努力坚持就会有希望">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YQ & 博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          03-Transaction交易
        </h1>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-27 00:00:00" itemprop="dateCreated datePublished" datetime="2022-10-27T00:00:00+08:00">2022-10-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-09 10:01:34" itemprop="dateModified" datetime="2023-11-09T10:01:34+08:00">2023-11-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81/" itemprop="url" rel="index">
                    <span itemprop="name">以太坊源码</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>12 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Transaction-一个交易的生老病死"><a href="#Transaction-一个交易的生老病死" class="headerlink" title="Transaction: 一个交易的生老病死"></a>Transaction: 一个交易的生老病死</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>我们知道，<strong>Ethereum的基本模型是基于交易的状态机模型</strong>(Transaction-based State Machine)，Transaction是Ethereum执行数据操作的媒介，它主要起到下面的几个作用:</p>
<ol>
<li>在Layer-1网络上的Account之间进行Native Token的转账。</li>
<li>创建新的Contract。</li>
<li>调用Contract中会修改目标Contract中持久化数据或者间接修改其他Account&#x2F;Contract数据的函数。</li>
</ol>
<p>这里我们对Transaction的功能性的细节再进行一些额外的补充。首先，<strong>Transaction只能创建Contract账户，而不能用于创建外部账户</strong>(EOA)。第二，<strong>如果调用Contract中的只读函数，是不需要构造Transaction</strong>的。相对的，所有参与Account&#x2F;Contract数据修改的操作都需要通过Transaction来进行。第三，广义上的Transaction只能由外部账户(EOA)构建。Contract是没有办法显式构造Layer-1层面的交易的。在某些合约函数的执行过程中，Contract在可以通过构造internal transaction来与其他的合约进行交互，但是这种Internal transaction与我们提到的Layer-1层面的交易有所不同，我们会在之后的章节介绍。</p>
<h2 id="LegacyTx-AccessListTX-DynamicFeeTx"><a href="#LegacyTx-AccessListTX-DynamicFeeTx" class="headerlink" title="LegacyTx &amp; AccessListTX &amp; DynamicFeeTx"></a>LegacyTx &amp; AccessListTX &amp; DynamicFeeTx</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/types/transaction.go</span></span><br><span class="line"><span class="keyword">type</span> Transaction <span class="keyword">struct</span> &#123;</span><br><span class="line"> inner TxData    <span class="comment">// 交易的共识内容</span></span><br><span class="line"> time  time.Time <span class="comment">// 首次在本地看到的时间(避免垃圾邮件)</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// 缓存</span></span><br><span class="line"> hash atomic.Value</span><br><span class="line"> size atomic.Value</span><br><span class="line"> from atomic.Value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们需要重点关注一下<code>inner</code>这个变量。目前与Transaction直接相关的数据都由这个变量来维护。</p>
<p>目前，<code>TxData</code>类型是一个接口，它的定义如下面的代码所示。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TxData <span class="keyword">interface</span> &#123;</span><br><span class="line">	txType() <span class="type">byte</span> <span class="comment">// returns the type ID</span></span><br><span class="line">	<span class="built_in">copy</span>() TxData <span class="comment">// 创建一个深拷贝和初始化所有字段</span></span><br><span class="line"></span><br><span class="line">	chainID() *big.Int</span><br><span class="line">	accessList() AccessList</span><br><span class="line">	data() []<span class="type">byte</span></span><br><span class="line">	gas() <span class="type">uint64</span></span><br><span class="line">	gasPrice() *big.Int</span><br><span class="line">	gasTipCap() *big.Int</span><br><span class="line">	gasFeeCap() *big.Int</span><br><span class="line">	value() *big.Int</span><br><span class="line">	nonce() <span class="type">uint64</span></span><br><span class="line">	to() *common.Address</span><br><span class="line">	blobGas() <span class="type">uint64</span></span><br><span class="line">	blobGasFeeCap() *big.Int</span><br><span class="line">	blobHashes() []common.Hash</span><br><span class="line"></span><br><span class="line">	rawSignatureValues() (v, r, s *big.Int)</span><br><span class="line">	setSignatureValues(chainID, v, r, s *big.Int)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//在给定包含区块baseFee的情况下，计算交易支付的gas价格。</span></span><br><span class="line">    <span class="comment">//不像其他TxData方法，返回*大。Int应该是计算值的独立副本，即允许调用者改变结果。</span></span><br><span class="line">    <span class="comment">//方法实现可以使用&#x27;dst&#x27;来存储结果。</span></span><br><span class="line">	effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原来的TxData现在被声明成了一个interface，是为了后续版本的更新中可以对Transaction类型进行更加灵活的修改。目前，在Ethereum中定义了三种类型的Transaction来实现TxData这个接口。按照时间上的定义顺序来说，这三种类型的Transaction分别是，LegacyT，AccessListTx，TxDynamicFeeTx。</p>
<p>LegacyTx：是原始的Ethereum的Transaction设计</p>
<p>AccessListTX：是基于EIP-2930(Berlin分叉)的Transaction。</p>
<p>DynamicFeeTx：是<a target="_blank" rel="noopener" href="https://eips.ethereum.org/EIPS/eip-1559">EIP-1559</a>(伦敦分叉)生效之后的默认的Transaction。</p>
<h3 id="LegacyTx"><a href="#LegacyTx" class="headerlink" title="LegacyTx"></a>LegacyTx</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> LegacyTx <span class="keyword">struct</span> &#123;</span><br><span class="line"> Nonce    <span class="type">uint64</span>          <span class="comment">// nonce of sender account</span></span><br><span class="line"> GasPrice *big.Int        <span class="comment">// wei per gas</span></span><br><span class="line"> Gas      <span class="type">uint64</span>          <span class="comment">// gas limit</span></span><br><span class="line"> To       *common.Address <span class="string">`rlp:&quot;nil&quot;`</span> <span class="comment">// nil means contract creation</span></span><br><span class="line"> Value    *big.Int        <span class="comment">// wei amount</span></span><br><span class="line"> Data     []<span class="type">byte</span>          <span class="comment">// contract invocation input data</span></span><br><span class="line"> V, R, S  *big.Int        <span class="comment">// signature values</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AccessListTX"><a href="#AccessListTX" class="headerlink" title="AccessListTX"></a>AccessListTX</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> AccessListTx <span class="keyword">struct</span> &#123;</span><br><span class="line"> ChainID    *big.Int        <span class="comment">// destination chain ID</span></span><br><span class="line"> Nonce      <span class="type">uint64</span>          <span class="comment">// nonce of sender account</span></span><br><span class="line"> GasPrice   *big.Int        <span class="comment">// wei per gas</span></span><br><span class="line"> Gas        <span class="type">uint64</span>          <span class="comment">// gas limit</span></span><br><span class="line"> To         *common.Address <span class="string">`rlp:&quot;nil&quot;`</span> <span class="comment">// nil means contract creation</span></span><br><span class="line"> Value      *big.Int        <span class="comment">// wei amount</span></span><br><span class="line"> Data       []<span class="type">byte</span>          <span class="comment">// contract invocation input data</span></span><br><span class="line"> AccessList AccessList      <span class="comment">// EIP-2930 access list</span></span><br><span class="line"> V, R, S    *big.Int        <span class="comment">// signature values</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DynamicFeeTx"><a href="#DynamicFeeTx" class="headerlink" title="DynamicFeeTx"></a>DynamicFeeTx</h3><p>如果我们观察DynamicFeeTx就会发现，DynamicFeeTx的定义其实就是在LegacyTx&#x2F;AccessListTX的定义的基础上额外的增加了GasTipCap与GasFeeCap这两个字段。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DynamicFeeTx <span class="keyword">struct</span> &#123;</span><br><span class="line"> ChainID    *big.Int</span><br><span class="line"> Nonce      <span class="type">uint64</span></span><br><span class="line"> GasTipCap  *big.Int <span class="comment">// a.k.a. maxPriorityFeePerGas</span></span><br><span class="line"> GasFeeCap  *big.Int <span class="comment">// a.k.a. maxFeePerGas</span></span><br><span class="line"> Gas        <span class="type">uint64</span></span><br><span class="line"> To         *common.Address <span class="string">`rlp:&quot;nil&quot;`</span> <span class="comment">// nil means contract creation</span></span><br><span class="line"> Value      *big.Int</span><br><span class="line"> Data       []<span class="type">byte</span></span><br><span class="line"> AccessList AccessList</span><br><span class="line"></span><br><span class="line"> <span class="comment">// Signature values</span></span><br><span class="line"> V *big.Int <span class="string">`json:&quot;v&quot; gencodec:&quot;required&quot;`</span></span><br><span class="line"> R *big.Int <span class="string">`json:&quot;r&quot; gencodec:&quot;required&quot;`</span></span><br><span class="line"> S *big.Int <span class="string">`json:&quot;s&quot; gencodec:&quot;required&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Transaction的执行流程"><a href="#Transaction的执行流程" class="headerlink" title="Transaction的执行流程"></a>Transaction的执行流程</h2><p>Transaction的执行主要在发生在两个Workflow中:</p>
<ol>
<li><strong>Miner在打包新的Block时。此时Miner会按Block中Transaction的打包顺序来执行其中的Transaction。</strong></li>
<li><strong>其他节点添加Block到Blockchain时</strong>。当<strong>节点从网络中监听并获取到新的Block时，它们会执行Block中的Transaction</strong>，来更新本地的State Trie的 Root，并与Block Header中的State Trie Root进行比较，来验证Block的合法性。</li>
</ol>
<p>一条Transaction执行，可能会涉及到多个Account&#x2F;Contract的值的变化，最终造成一个或多个Account的State的发生转移。在<strong>Byzantium分叉之前的Geth版本中，在每个Transaction执行之后，都会计算一个当前的State Trie Root，并写入到对应的Transaction Receipt中。</strong>这符合以太坊黄皮书中的原始设计。即交易是使得Ethereum状态机发生状态状态转移的最细粒度单位。读者们可能已经来开产生疑惑了，“每个Transaction都会重算一个State Trie Root”的方式岂不是会带来大量的计算(重算一次一个MPT Path上的所有Node)和读写开销(新生成的MPT Node是很有可能最终被持久化到LevelDB中的)？结论是显然的。因此<strong>在Byzantium分叉之后，在一个Block的验证周期中只会计算一次的State Root。</strong>我们仍然可以在<code>state_processor.go</code>找寻到早年代码的痕迹。最终，一个Block中所有Transaction执行的结果使得World State发生状态转移。下面我们就来根据geth代码库中的调用关系，从Miner的视角来探索一个Transaction的生命周期。</p>
<h3 id="Native-Token-Transferring-Transaction"><a href="#Native-Token-Transferring-Transaction" class="headerlink" title="Native Token Transferring Transaction"></a>Native Token Transferring Transaction</h3><h3 id="Transaction修改Contract的持久化存储的"><a href="#Transaction修改Contract的持久化存储的" class="headerlink" title="Transaction修改Contract的持久化存储的"></a>Transaction修改Contract的持久化存储的</h3><p>在Ethereum中，当Miner开始构造新的区块的时候，首先会启动 <code>mainLoop()</code>函数。具体的函数如下所示。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// miner/worker.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *worker)</span></span> mainLoop() &#123;</span><br><span class="line">    ....</span><br><span class="line">    txs := <span class="built_in">make</span>(<span class="keyword">map</span>[common.Address]types.Transactions)</span><br><span class="line">    <span class="keyword">for</span> _, tx := <span class="keyword">range</span> ev.Txs &#123;</span><br><span class="line">        acc, _ := types.Sender(w.current.signer, tx)</span><br><span class="line">        txs[acc] = <span class="built_in">append</span>(txs[acc], tx)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里看到，通过NewTransactionsByPriceAndNonce获取一部分的Tx并打包</span></span><br><span class="line">    txset := types.NewTransactionsByPriceAndNonce(w.current.signer, txs, w.current.header.BaseFee)</span><br><span class="line">    tcount := w.current.tcount</span><br><span class="line">    <span class="comment">//提交打包任务</span></span><br><span class="line">    w.commitTransactions(w.current, txset, <span class="literal">nil</span>)        </span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Mining新区块前，<strong>Worker首先需要决定，哪些Transaction会被打包到新的Block中</strong>。这里选取Transaction其实经历了两个步骤。首先，**<code>txs</code>变量保存了从Transaction Pool中拿到的合法的交易，以及准备好被打包的交易。**这里举一个例子，来说明什么是准备好被打包的交易，比如Alice先后发了新三个交易到网络中，对应的Nonce分别是100和101，102。假如Miner只收到了100和102号交易。那么对于此刻的Transaction Pool来说Nonce 100的交易就是准备好被打包的交易，交易Nonce 是102需要等待Nonce 101的交易被确认之后才能提交。</p>
<p>在<strong>Worker会从Transaction Pool中拿出若干的transaction, 赋值给<em>txs</em></strong>之后, 然后<strong>调用<code>NewTransactionsByPriceAndNonce</code>函数按照Gas Price和Nonce对<em>txs</em>进行排序，并将结果赋值给<em>txset</em></strong>。此外在Worker的实例中，还存在<code>fillTransactions</code>函数，为了未来定制化的给Transaction的执行顺序进行排序。</p>
<p>在<strong>拿到<em>txset</em>之后，mainLoop函数会调用<code>commitTransactions</code>函数，正式进入Mining新区块的流程</strong>。<code>commitTransactions</code>函数如下所示。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *worker)</span></span> commitTransactions(env *environment,txs *types.TransactionsByPriceAndNonce,interrupt *atomic.Int32) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 首先给Block设置最大可以使用的Gas的上限</span></span><br><span class="line">    gasLimit := env.header.GasLimit</span><br><span class="line">    <span class="keyword">if</span> env.gasPool == <span class="literal">nil</span> &#123;</span><br><span class="line">		env.gasPool = <span class="built_in">new</span>(core.GasPool).AddGas(gasLimit)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 函数的主体是一个For循环</span></span><br><span class="line">    <span class="keyword">for</span>&#123;</span><br><span class="line">    	.....</span><br><span class="line">        <span class="comment">// 如果我们没有足够的gas进行任何进一步的交易，循环结束</span></span><br><span class="line">		<span class="keyword">if</span> env.gasPool.Gas() &lt; params.TxGas &#123;</span><br><span class="line">			log.Trace(<span class="string">&quot;Not enough gas for further transactions&quot;</span>, <span class="string">&quot;have&quot;</span>, env.gasPool, <span class="string">&quot;want&quot;</span>, params.TxGas)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">        tx := txs.Peek()</span><br><span class="line">        <span class="keyword">if</span> tx == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        ....</span><br><span class="line">        <span class="comment">// 开始执行交易</span></span><br><span class="line">        env.state.SetTxContext(tx.Hash(), env.tcount)</span><br><span class="line">        logs, err := w.commitTransaction(env, tx)</span><br><span class="line">        ....</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>commitTransactions</code>函数的主体是一个for循环，<strong>每次获取结构体切片头部的txs.Peek()的transaction</strong>，并作为参数调用函数miner&#x2F;worker.go的<code>commitTransaction()</code>。<code>commitTransaction()</code>函数如下所示。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *worker)</span></span> commitTransaction(env *environment, tx *types.Transaction) ([]*types.Log, <span class="type">error</span>)&#123;</span><br><span class="line">    <span class="comment">// 在每次commitTransaction执行前都要记录当前StateDB的Snapshot,一旦交易执行失败则基于这个Snapshot进行回滚。</span></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">		snap = env.state.Snapshot()</span><br><span class="line">		gp   = env.gasPool.Gas()</span><br><span class="line">	)</span><br><span class="line">    <span class="comment">// 调用执行Transaction的函数</span></span><br><span class="line">    receipt, err := core.ApplyTransaction(w.chainConfig, w.chain, &amp;env.coinbase, env.gasPool, env.state, env.header, tx, &amp;env.header.GasUsed, *w.chain.GetVMConfig())</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Blockchain系统中的<strong>Transaction</strong>和DBMS中的Transaction一样，<strong>要么完成要么失败</strong>。所以在调用执行Transaction的函数前，<strong>首先记录了一下当前world state的Snapshot，用于交易失败时回滚操作</strong>。之后调用ApplyTransaction()函数。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/state_processor.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ApplyTransaction</span><span class="params">(config *params.ChainConfig, bc ChainContext, author *common.Address, gp *GasPool, statedb *state.StateDB, header *types.Header, tx *types.Transaction, usedGas *<span class="type">uint64</span>, cfg vm.Config)</span></span> (*types.Receipt, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 将Transaction 转化为Message的形式</span></span><br><span class="line">    msg, err := TransactionToMessage(tx, types.MakeSigner(config, header.Number, header.Time), header.BaseFee)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建要在EVM环境中使用的新上下文</span></span><br><span class="line">    blockContext := NewEVMBlockContext(header, bc, author)</span><br><span class="line">    vmenv := vm.NewEVM(blockContext, vm.TxContext&#123;&#125;, statedb, config, cfg)</span><br><span class="line">    <span class="comment">// 调用执行Contract的函数</span></span><br><span class="line">    <span class="keyword">return</span> applyTransaction(msg, config, gp, statedb, header.Number, header.Hash(), tx, usedGas, vmenv)</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>

<p><strong>在 ApplyTransaction()函数中首先Transaction会被转换成Message的形式。</strong>在执行每一个Transaction的时候，<strong>都会生成一个新的EVM来执行</strong>。之后调用applyTransaction()函数来执行Message。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/state_processor.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">applyTransaction</span><span class="params">(msg *Message, config *params.ChainConfig, gp *GasPool, statedb *state.StateDB, blockNumber *big.Int, blockHash common.Hash, tx *types.Transaction, usedGas *<span class="type">uint64</span>, evm *vm.EVM)</span></span> (*types.Receipt, <span class="type">error</span>) &#123;</span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">// 将交易应用到当前状态(包含在环境中)。</span></span><br><span class="line">    result, err := ApplyMessage(evm, msg, gp)</span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>之后调用ApplyMessage()函数。</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/state_transition.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ApplyMessage</span><span class="params">(evm *vm.EVM, msg Message, gp *GasPool)</span></span> (*ExecutionResult, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> NewStateTransition(evm, msg, gp).TransitionDb()</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>

<p><strong>之后调用TransitionDb()函数。</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/state_transition.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(st *StateTransition)</span></span> TransitionDb() (*ExecutionResult, <span class="type">error</span>) &#123;</span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">var</span> contractCreation = msg.To == <span class="literal">nil</span></span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">if</span> contractCreation &#123;</span><br><span class="line">        <span class="comment">//创建合约</span></span><br><span class="line">		ret, _, st.gasRemaining, vmerr = st.evm.Create(sender, msg.Data, st.gasRemaining, msg.Value)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 增加下一个交易的nonce</span></span><br><span class="line">		st.state.SetNonce(msg.From, st.state.GetNonce(sender.Address())+<span class="number">1</span>)</span><br><span class="line">		ret, st.gasRemaining, vmerr = st.evm.Call(sender, st.to(), msg.Data, st.gasRemaining, msg.Value)</span><br><span class="line">	&#125;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>之后调用Call()函数</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/vm/evm.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(evm *EVM)</span></span> Call(caller ContractRef, addr common.Address, input []<span class="type">byte</span>, gas <span class="type">uint64</span>, value *big.Int) (ret []<span class="type">byte</span>, leftOverGas <span class="type">uint64</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">// 执行合约</span></span><br><span class="line">    ret, err = evm.interpreter.Run(contract, input, <span class="literal">false</span>)</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>之后调用Run()函数。</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/vm/interpreter.go</span></span><br><span class="line"><span class="comment">// Run循环并使用给定的输入数据计算合约代码，并返回返回的字节片，如果发生错误则返回一个错误。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(in *EVMInterpreter)</span></span> Run(contract *Contract, input []<span class="type">byte</span>, readOnly <span class="type">bool</span>) (ret []<span class="type">byte</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">    ....</span><br><span class="line">    op = contract.GetOp(pc)</span><br><span class="line">    operation := in.cfg.JumpTable[op]</span><br><span class="line">    cost = operation.constantGas <span class="comment">// For tracing</span></span><br><span class="line">    <span class="comment">// UseGas 函数：当前剩余的gas减去操作所需gas</span></span><br><span class="line">    <span class="comment">// 剩余的gas小于input直接返回false</span></span><br><span class="line">    <span class="comment">// 否则当前的gas减去操作所需gas并返回true</span></span><br><span class="line">    <span class="keyword">if</span> !contract.UseGas(cost) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, ErrOutOfGas</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">// 执行操作</span></span><br><span class="line">    res, err = operation.execute(&amp;pc, in, callContext)</span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在更细粒度的层面<strong>，每个opcode循环调用core&#x2F;vm&#x2F;jump_table.go中的execute函数</strong>。这里值得一提的是，获取Contract中每条Operate的方式，是从Contact中的code数组中按照第n个拿取。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/vm/contract.go</span></span><br><span class="line"><span class="comment">// GetOp返回合约字节数组中的第n个元素</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Contract)</span></span> GetOp(n <span class="type">uint64</span>) OpCode &#123;</span><br><span class="line"> <span class="keyword">return</span> OpCode(c.GetByte(n))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>OPCODE的具体实现代码位于core&#x2F;vm&#x2F;instructor.go文件中</strong>。比如，<strong>对Contract中持久化数据修改的OPSSTORE指令的实现位于opStore()函数中</strong>。而<strong>opStore的函数的具体操作又是调用了StateDB中的SetState函数</strong>，将Go-ethereum中的几个主要的模块串联了起来。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">opSstore</span><span class="params">(pc *<span class="type">uint64</span>, interpreter *EVMInterpreter, scope *ScopeContext)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    loc := scope.Stack.pop()</span><br><span class="line">    val := scope.Stack.pop()</span><br><span class="line">    <span class="comment">//根据指令跟地址来修改StateDB中某一存储位置的值。</span></span><br><span class="line">    interpreter.evm.StateDB.SetState(scope.Contract.Address(),loc.Bytes32(), val.Bytes32())</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//core/state/stateDB</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StateDB)</span></span> SetState(addr common.Address, key, value common.Hash) &#123;</span><br><span class="line">    stateObject := s.GetOrNewStateObject(addr)</span><br><span class="line">    <span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">    	stateObject.SetState(s.db, key, value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于一条调用合约函数的交易，其中必然会存在修改StateDB的操作。通过上述的函数调用关系，我们就完成了在一个新区块的形成过程中，Transaction如何修改StateDB的Workflow。</p>
</blockquote>
<p>commitTransactions –&gt; commitTransaction –&gt; ApplyTransaction –&gt; applyTransaction –&gt;  ApplyMessage –&gt; TransactionDB –&gt; Call –&gt; Run –&gt; opSstore –&gt; StateDB –&gt; StateObject –&gt; Key-Value-Trie</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">commitTransactions --&gt; commitTransaction --&gt; ApplyTransaction --&gt; applyTransaction --&gt;  ApplyMessage --&gt; TransactionDB --&gt; Call --&gt; Run --&gt; opSstore --&gt; StateDB --&gt; StateObject --&gt; Key-Value-Trie</span><br></pre></td></tr></table></figure>

<p><img src="/noteimg/%E5%8C%BA%E5%9D%97%E9%93%BE/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81/img/tx_exec_calls.png" alt="Transaction Execution stack Flow"></p>
<h2 id="Validator-验证节点如何执行Transaction并更新World-State"><a href="#Validator-验证节点如何执行Transaction并更新World-State" class="headerlink" title="[Validator] 验证节点如何执行Transaction并更新World State"></a>[Validator] 验证节点如何执行Transaction并更新World State</h2><p>而<strong>对于不参与Mining的节点，他们执行Block中Transaction的入口是在core&#x2F;blockchain.go中的InsertChain()函数</strong>。InsertChain函数通过<strong>调用内部函数insertChain</strong>，其中<strong>调用中的core&#x2F;state_processor.go中的Process()函数</strong>。<strong>Process函数的核心在于循环遍历Block中的Transaction</strong>，调<strong>用上述的applyTransaction函数。从这里开始更底层的调用关系就与Mining Workflow中的调用关系相同。</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *StateProcessor)</span></span> Process(block *types.Block, statedb *state.StateDB, cfg vm.Config) (types.Receipts, []*types.Log, <span class="type">uint64</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	....</span><br><span class="line">	<span class="keyword">for</span> i, tx := <span class="keyword">range</span> block.Transactions() &#123;</span><br><span class="line">		msg, err := TransactionToMessage(tx, signer, header.BaseFee)</span><br><span class="line">		statedb.SetTxContext(tx.Hash(), i)</span><br><span class="line">		receipt, err := applyTransaction(msg, p.config, gp, statedb, blockNumber, blockHash, tx, usedGas, vmenv)</span><br><span class="line">		....</span><br><span class="line">	&#125;</span><br><span class="line">	....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="State-based-Blockchain：基于状态的区块链"><a href="#State-based-Blockchain：基于状态的区块链" class="headerlink" title="State-based Blockchain：基于状态的区块链"></a>State-based Blockchain：基于状态的区块链</h2><ul>
<li>State-based Blockchain 的数据主要由两部分的数据管理模块组成：World State 和 Blockchain。</li>
<li>State Object是系统中基于K-V结构的基础数据元素。在Ethereum中，State Object是Account。</li>
<li>World State表示了System中所有State Object的最新值的一个Snapshot，。</li>
<li>Blockchain是以块为单位的数据结构，每个块中包含了若干Transaction。Blockchain 可以被视为历史交易数据的组合。</li>
<li>Transaction是Blockchain System中与承载数据更新的载体。通过Transaction，State Object从当前状态切换到另一个状态。</li>
<li>World State的更新是以Block为单位的。</li>
</ul>
<h2 id="Read-Transaction-from-Database：从数据库读取交易"><a href="#Read-Transaction-from-Database：从数据库读取交易" class="headerlink" title="Read Transaction from Database：从数据库读取交易"></a>Read Transaction from Database：从数据库读取交易</h2><p>当我们想要通过Transaction的Hash查询一个Transaction具体的数据的时候，上层的API会调用<code>eth/api_backend.go</code>中的<code>GetTransaction()</code>函数，并最终调用了<code>core/rawdb/accessors_indexes.go</code>中的<code>ReadTransaction()</code>函数来查询。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eth/api_backend.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *EthAPIBackend)</span></span> GetTransaction(ctx context.Context, txHash common.Hash) (*types.Transaction, common.Hash, <span class="type">uint64</span>, <span class="type">uint64</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	tx, blockHash, blockNumber, index := rawdb.ReadTransaction(b.eth.ChainDb(), txHash)</span><br><span class="line">	<span class="keyword">return</span> tx, blockHash, blockNumber, index, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里值得注意的是，在读取Transaction的时候，<code>ReadTransaction()</code>函数<strong>首先获取了保存该Transaction的函数block body</strong>，并<strong>循环遍历该Block Body中获取到对应的Transaction</strong>。这是因为，虽然<strong>Transaction是作为一个基本的数据结构</strong>(Transaction Hash可以保证Transaction的唯一性)，但是<strong>在写入数据库的时候就是被按照Block Body的形式被整个的打包写入到Database中</strong>的。具体的可以查看<code>core/rawdb/accesssor_chain.go</code>中的<code>WriteBlock()</code>和<code>WriteBody()</code>函数。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadTransaction</span><span class="params">(db ethdb.Reader, hash common.Hash)</span></span> (*types.Transaction, common.Hash, <span class="type">uint64</span>, <span class="type">uint64</span>) &#123;</span><br><span class="line">	blockNumber := ReadTxLookupEntry(db, hash)</span><br><span class="line">	<span class="keyword">if</span> blockNumber == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, common.Hash&#123;&#125;, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line">	blockHash := ReadCanonicalHash(db, *blockNumber)</span><br><span class="line">	<span class="keyword">if</span> blockHash == (common.Hash&#123;&#125;) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, common.Hash&#123;&#125;, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 保存该Transaction的函数block body</span></span><br><span class="line">	body := ReadBody(db, blockHash, *blockNumber)</span><br><span class="line">	<span class="keyword">if</span> body == <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(<span class="string">&quot;Transaction referenced missing&quot;</span>, <span class="string">&quot;number&quot;</span>, *blockNumber, <span class="string">&quot;hash&quot;</span>, blockHash)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, common.Hash&#123;&#125;, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> txIndex, tx := <span class="keyword">range</span> body.Transactions &#123;</span><br><span class="line">		<span class="keyword">if</span> tx.Hash() == hash &#123;</span><br><span class="line">			<span class="keyword">return</span> tx, blockHash, *blockNumber, <span class="type">uint64</span>(txIndex)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	log.Error(<span class="string">&quot;Transaction not found&quot;</span>, <span class="string">&quot;number&quot;</span>, *blockNumber, <span class="string">&quot;hash&quot;</span>, blockHash, <span class="string">&quot;txhash&quot;</span>, hash)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, common.Hash&#123;&#125;, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    
    
    
      <div>
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:24px;">-------------本文结束感谢您的阅读-------------</div>
    
</div>
      </div>
    
        <div class="reward-container">
  <div>原创技术分享，您的支持将鼓励我继续创作.</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    点击打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="幺柒YQ 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="幺柒YQ 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>幺柒YQ
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://kongpengyq.com/2022/10/27/%E5%8C%BA%E5%9D%97%E9%93%BE/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81/03-Transaction%E4%BA%A4%E6%98%93/" title="03-Transaction交易">https://kongpengyq.com/2022/10/27/区块链/以太坊源码/03-Transaction交易/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

            <div class="social-item">
              <a target="_blank" class="social-link" href="https://twitter.com/qiyao666">
                <span class="icon">
                  <i class="fa fa-twitter"></i>
                </span>

                <span class="label">Twitter</span>
              </a>
            </div>

            <div class="social-item">
              <a target="_blank" class="social-link" href="/images/wechat.jpg">
                <span class="icon">
                  <i class="fa fa-wechat"></i>
                </span>

                <span class="label">Wechat</span>
              </a>
            </div>

            <div class="social-item">
              <a target="_blank" class="social-link" href="/atom.xml">
                <span class="icon">
                  <i class="fa fa-rss"></i>
                </span>

                <span class="label">RSS</span>
              </a>
            </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag"># 区块链</a>
              <a href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81/" rel="tag"># 以太坊源码</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/10/21/%E5%8C%BA%E5%9D%97%E9%93%BE/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81/02-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/" rel="prev" title="02-状态管理">
      <i class="fa fa-chevron-left"></i> 02-状态管理
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/10/30/%E5%8C%BA%E5%9D%97%E9%93%BE/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81/04-Blockchain%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="next" title="04-Blockchain区块链">
      04-Blockchain区块链 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC81OTA3NC8zNTUzNg=="></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Transaction-%E4%B8%80%E4%B8%AA%E4%BA%A4%E6%98%93%E7%9A%84%E7%94%9F%E8%80%81%E7%97%85%E6%AD%BB"><span class="nav-text">Transaction: 一个交易的生老病死</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LegacyTx-AccessListTX-DynamicFeeTx"><span class="nav-text">LegacyTx &amp; AccessListTX &amp; DynamicFeeTx</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LegacyTx"><span class="nav-text">LegacyTx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AccessListTX"><span class="nav-text">AccessListTX</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DynamicFeeTx"><span class="nav-text">DynamicFeeTx</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Transaction%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-text">Transaction的执行流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Native-Token-Transferring-Transaction"><span class="nav-text">Native Token Transferring Transaction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transaction%E4%BF%AE%E6%94%B9Contract%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8%E7%9A%84"><span class="nav-text">Transaction修改Contract的持久化存储的</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Validator-%E9%AA%8C%E8%AF%81%E8%8A%82%E7%82%B9%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8CTransaction%E5%B9%B6%E6%9B%B4%E6%96%B0World-State"><span class="nav-text">[Validator] 验证节点如何执行Transaction并更新World State</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#State-based-Blockchain%EF%BC%9A%E5%9F%BA%E4%BA%8E%E7%8A%B6%E6%80%81%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE"><span class="nav-text">State-based Blockchain：基于状态的区块链</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Read-Transaction-from-Database%EF%BC%9A%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AF%BB%E5%8F%96%E4%BA%A4%E6%98%93"><span class="nav-text">Read Transaction from Database：从数据库读取交易</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="幺柒YQ"
      src="/images/avater.png">
  <p class="site-author-name" itemprop="name">幺柒YQ</p>
  <div class="site-description" itemprop="description">努力坚持就会有希望</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">232</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/kpyaoqi" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kpyaoqi" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:18312386077@163.com" title="E-Mail → mailto:18312386077@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/wechat.jpg" title="WeChat → images&#x2F;wechat.jpg"><i class="fa fa-fw fa-wechat"></i>WeChat</a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/qq.jpg" title="QQ → images&#x2F;qq.jpg"><i class="fa fa-fw fa-qq"></i>QQ</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://baidu.com/" title="https:&#x2F;&#x2F;baidu.com" rel="noopener" target="_blank">百度</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://stackoverflow.com/" title="https:&#x2F;&#x2F;stackoverflow.com&#x2F;" rel="noopener" target="_blank">Stackoverflow</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2021-11 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">幺柒YQ</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">899k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">13:37</span>
</div>

<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共379.4k字</span>
</div>


    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人</span>
    <span class="post-meta-divider">|</span>
<!-- 不蒜子计数初始值纠正 -->
<script>
$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});
</script> 

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

</body>
</html>
